<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mind Mosaic Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- COLOR PALETTE --- */
            --bg-body: #f3f4f6;       
            --bg-surface: #ffffff;
            --bg-board: #e5e7eb;      
            
            --primary: #3b82f6;       
            --primary-dark: #2563eb;
            --primary-soft: #eff6ff;
            
            --text-main: #111827;     
            --text-muted: #6b7280;    
            
            --success: #10b981;
            --magic: #8b5cf6;         
            --warning: #f59e0b;
            
            /* --- SHADOWS --- */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-panel: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --shadow-btn: 0 2px 4px rgba(0,0,0,0.05);
            
            --shadow-tile: 
                0 4px 0 #cbd5e1, 
                0 6px 8px rgba(0,0,0,0.05);
            
            --shadow-tile-correct:
                0 4px 0 #6ee7b7,
                inset 0 0 0 2px #34d399;

            --radius-xl: 28px;
            --radius-lg: 20px;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh; height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }

        /* --- TOASTS --- */
        #toast-container {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 9999;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px;
        }
        .toast {
            background: #ffffff; padding: 14px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); border: 1px solid #f3f4f6;
            display: flex; align-items: center; gap: 12px; pointer-events: auto;
            animation: slideDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .toast i { font-size: 1.2rem; }
        .toast.success i { color: var(--success); }
        .toast.magic i { color: var(--magic); }
        .toast.warning i { color: var(--warning); }
        .toast-text { font-size: 0.95rem; font-weight: 600; color: var(--text-main); }

        /* --- LAYOUT --- */
        #app {
            width: 100%; height: 100%; padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; position: relative; z-index: 10;
        }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: center; animation: fadeUp 0.4s ease-out; }
        .screen.active { display: flex; }

        /* --- MAIN MENU --- */
        /* Updated to ensure footer is absolutely at bottom */
        #menu-screen { position: relative; justify-content: center; }

        .menu-wrapper { 
            width: 100%; max-width: 400px; 
            display: flex; flex-direction: column; align-items: center; text-align: center; gap: 40px; 
            /* Optical centering adjustment */
            margin-bottom: 40px; 
        }
        
        .logo-symbol {
            width: 80px; height: 80px; margin-bottom: 20px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
            transform: rotate(-5deg);
        }
        .lp { background: var(--primary); border-radius: 10px; }
        .lp.p1 { opacity:1; } .lp.p2 { opacity:0.8; } .lp.p3 { opacity:0.6; } .lp.p4 { border: 2px dashed #cbd5e1; background: transparent; }

        h1 { font-size: 2.8rem; font-weight: 900; color: var(--text-main); margin: 0; letter-spacing: -1px; line-height: 1; }
        p.subtitle { font-size: 1.1rem; color: var(--text-muted); font-weight: 500; margin-top: 8px; }

        .menu-buttons { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .menu-btn {
            width: 100%; padding: 22px 24px; background: white; border: 1px solid #e5e7eb;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-btn);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.1rem; font-weight: 600; color: var(--text-main);
            cursor: pointer; transition: all 0.2s;
        }
        .menu-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-panel); }
        .menu-btn small { color: var(--text-muted); font-weight: 400; font-size: 0.9em; }

        /* Footer Fixed at Bottom */
        .footer-legal { 
            position: absolute; 
            bottom: calc(20px + env(safe-area-inset-bottom)); /* Safe area respect */
            left: 0; width: 100%; 
            text-align: center; 
            font-size: 0.8rem; color: var(--text-muted); opacity: 0.7; 
        }
        .footer-legal a { cursor: pointer; border-bottom: 1px dotted currentColor; transition: 0.2s; }
        .footer-legal a:hover { color: var(--primary); opacity: 1; }

        /* --- GAME SCREEN --- */
        .game-stage {
            display: flex; flex-direction: column; align-items: center; gap: 30px;
            width: 100%; max-width: 500px; height: 100%; justify-content: center;
        }
        @media (min-width: 1024px) {
            .game-stage { flex-direction: row; max-width: 1100px; gap: 60px; align-items: center; }
            .board-section { order: 1; }
            .sidebar-section { order: 2; width: 320px; height: auto; }
        }

        .top-nav { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .link-btn { background: none; border: none; color: var(--text-muted); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-size: 0.9rem; }
        .link-btn:hover { color: var(--primary); }

        .board-tray {
            padding: 12px; background: var(--bg-board); border-radius: 32px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
        }
        #game-board { position: relative; transition: width 0.1s, height 0.1s; }

        .tile {
            position: absolute; background: var(--bg-surface);
            display: flex; justify-content: center; align-items: center;
            font-weight: 800; color: var(--text-main);
            border-radius: 14px; cursor: pointer;
            box-shadow: var(--shadow-tile);
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1;
        }
        .tile:active { transform: scale(0.96); }
        .tile.correct { background: #ecfdf5; color: var(--success); box-shadow: var(--shadow-tile-correct); }
        .tile.correct::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; bottom: 6px; right: 6px; font-size: 0.7em; opacity: 0.6; }

        /* Sidebar */
        .sidebar-panel {
            background: white; padding: 25px; border-radius: 28px;
            box-shadow: var(--shadow-panel); border: 1px solid #f3f4f6;
            display: flex; flex-direction: column; gap: 25px; width: 100%;
        }

        .stats-group { display: flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6; padding-bottom: 20px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .stat-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
        .stat-val { font-size: 1.3rem; font-weight: 800; color: var(--text-main); font-variant-numeric: tabular-nums; }
        .stat-val.highlight { color: var(--primary); }

        .action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .big-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            padding: 15px; background: var(--primary-soft); border: none; border-radius: 18px;
            color: var(--primary); font-weight: 700; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .big-btn i { font-size: 1.5rem; }
        .big-btn:hover { background: var(--primary); color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .big-btn:active { transform: scale(0.96); }
        .big-btn.magic { background: #f5f3ff; color: var(--magic); }
        .big-btn.magic:hover { background: var(--magic); color: white; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); }
        .big-btn.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        .badge {
            position: absolute; top: 8px; right: 8px;
            background: #ffffff; color: var(--text-main); font-size: 0.75rem;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .system-group { display: flex; justify-content: center; gap: 12px; }
        .sys-btn {
            width: 48px; height: 48px; border-radius: 14px; border: 1px solid #e5e7eb;
            background: white; color: var(--text-muted); font-size: 1.1rem;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .sys-btn:hover { border-color: var(--text-muted); color: var(--text-main); transform: translateY(-2px); }
        .sys-btn:active { transform: scale(0.95); }

        .github-pill {
            display: block; text-align: center; margin-top: 20px;
            font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-decoration: none;
            opacity: 0.7; transition: 0.2s;
        }
        .github-pill:hover { opacity: 1; color: var(--primary); }

        /* --- MODALS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
            opacity: 0; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; }
        
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 40px;
            border-radius: 32px; text-align: center;
            box-shadow: 0 25px 60px -12px rgba(0,0,0,0.15); border: 1px solid #e5e7eb;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .overlay.active .modal-box { transform: scale(1); }

        .modal-icon { font-size: 3rem; margin-bottom: 20px; color: var(--primary); }
        .modal-title { font-size: 1.6rem; font-weight: 800; margin-bottom: 10px; color: var(--text-main); }
        .modal-desc { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 30px; }
        
        .btn-primary {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: var(--primary); color: white; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }

        /* Paused View */
        .paused-view {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 20;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 28px;
        }
        .paused-view.active { display: flex; }

        @keyframes arrowPop { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        .arrow-hint {
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
            color: var(--primary); font-size: 2.5rem; pointer-events: none; z-index: 10;
            animation: arrowPop 0.4s forwards; filter: drop-shadow(0 2px 4px rgba(255,255,255,1));
        }
        
        .htp-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; text-align: left; }
        .htp-icon { width: 40px; height: 40px; border-radius: 12px; background: var(--primary-soft); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div id="toast-container"></div>

<div id="modal-overlay" class="overlay">
    <div class="modal-box">
        <div id="m-icon" class="modal-icon"></div>
        <h2 id="m-title" class="modal-title"></h2>
        <p id="m-desc" class="modal-desc"></p>
        <button id="m-btn" class="btn-primary"></button>
    </div>
</div>

<div id="htp-overlay" class="overlay">
    <div class="modal-box">
        <h2 class="modal-title">How to Play</h2>
        <div style="margin-bottom: 30px;">
            <div class="htp-row">
                <div class="htp-icon"><i class="fas fa-hand-pointer"></i></div>
                <div>Slide tiles into the empty space to sort them 1-15.</div>
            </div>
            <div class="htp-row">
                <div class="htp-icon"><i class="fas fa-lightbulb"></i></div>
                <div>Use <strong>Hints</strong> wisely. Earn more by solving!</div>
            </div>
            <div class="htp-row">
                <div class="htp-icon"><i class="fas fa-wand-magic-sparkles"></i></div>
                <div><strong>Magic Wand</strong> auto-solves one tile.</div>
            </div>
        </div>
        <button class="btn-primary" onclick="UI.closeModal('htp-overlay')">Start Playing</button>
    </div>
</div>

<div id="legal-overlay" class="overlay">
    <div class="modal-box" style="text-align: left;">
        <div style="text-align:center; font-size:2.5rem; color:var(--text-main); margin-bottom:10px;"><i class="fas fa-scale-balanced"></i></div>
        <h2 style="text-align:center; margin-bottom:20px;">Legal Notice</h2>
        <div style="max-height:50vh; overflow-y:auto; font-size:0.9rem; color:var(--text-muted); line-height:1.6; margin-bottom:20px;">
            <p style="margin-bottom:10px;"><strong>Mind Mosaic</strong> is developed by <strong>Ramazan Çetinkaya</strong>.</p>
            <p style="margin-bottom:10px;">This software is for <strong>Educational Use Only</strong>.</p>
            <p>Unauthorized commercial use or public redistribution is strictly prohibited.</p>
            <p style="margin-top:15px; font-size:0.8rem; opacity:0.8;">&copy; 2025 All Rights Reserved.</p>
        </div>
        <button class="btn-primary" onclick="UI.closeModal('legal-overlay')">Close</button>
    </div>
</div>

<div id="app">
    <div id="menu-screen" class="screen active">
        <div class="menu-wrapper">
            
            <div style="display:flex; justify-content:center;">
                <div class="logo-symbol">
                    <div class="lp p1"></div><div class="lp p2"></div><div class="lp p3"></div><div class="lp p4"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 10px;">
                <h1>Mind Mosaic</h1>
                <p class="subtitle">Bring order to chaos.</p>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn" onclick="Game.startGame('easy')">
                    <span>Easy</span><small>3x3</small>
                </button>
                <button class="menu-btn" onclick="Game.startGame('medium')">
                    <span>Medium</span><small>4x4</small>
                </button>
                <button class="menu-btn" onclick="Game.startGame('hard')">
                    <span>Hard</span><small>5x5</small>
                </button>
            </div>
        </div>

        <div class="footer-legal">
            <a onclick="UI.openModal('legal-overlay')">Legal Notice</a> &bull; &copy; 2025 Ramazan Çetinkaya
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="game-stage">
            
            <div class="board-section">
                <div class="top-nav">
                    <button class="link-btn" onclick="UI.openModal('htp-overlay')"><i class="far fa-question-circle"></i> Guide</button>
                </div>
                <div class="board-tray">
                    <div id="game-board"></div>
                    <div id="paused-view" class="paused-view">
                        <i class="fas fa-pause" style="font-size:3rem; color:var(--primary); margin-bottom:20px;"></i>
                        <h2 style="margin-bottom:20px; color:var(--text-main);">Paused</h2>
                        <button class="btn-primary" style="width:auto; padding:12px 40px;" onclick="Game.togglePause()">Resume</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-panel">
                    
                    <div class="stats-group">
                        <div class="stat-item">
                            <span class="stat-label">Moves</span>
                            <span class="stat-val" id="val-moves">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Time</span>
                            <span class="stat-val highlight" id="val-time">00:00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Best</span>
                            <span class="stat-val" id="val-best">-</span>
                        </div>
                    </div>

                    <div class="action-group">
                        <button class="big-btn" id="btn-hint" onclick="Game.useHint()" title="Use Hint">
                            <i class="far fa-lightbulb"></i>
                            <span>Hint</span>
                            <div class="badge" id="val-hints">3</div>
                        </button>
                        <button class="big-btn magic" id="btn-magic" onclick="Game.useMagic()" title="Magic Wand">
                            <i class="fas fa-wand-magic-sparkles"></i>
                            <span>Magic</span>
                        </button>
                    </div>

                    <div class="system-group">
                        <button class="sys-btn" onclick="Game.togglePause()" title="Pause"><i id="icon-pause" class="fas fa-pause"></i></button>
                        <button class="sys-btn" id="btn-sound" onclick="AudioController.toggle()" title="Sound"><i class="fas fa-volume-up"></i></button>
                        <button class="sys-btn" onclick="Game.quitGame()" title="Quit Game" style="color: #ef4444; border-color: #fecaca;"><i class="fas fa-times"></i></button>
                    </div>

                </div>

                <a href="https://github.com/ramazancetinkaya/mind-mosaic-game" target="_blank" class="github-pill">
                    <i class="fab fa-github"></i> View Source Code
                </a>
            </div>

        </div>
    </div>
</div>

<script>
/** AUDIO */
const AudioController = {
    ctx: null, enabled: true,
    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if(localStorage.getItem('mm_sound')==='off'){ this.enabled=false; document.getElementById('btn-sound').innerHTML='<i class="fas fa-volume-mute"></i>'; }
    },
    toggle() {
        this.enabled = !this.enabled; localStorage.setItem('mm_sound', this.enabled?'on':'off');
        document.getElementById('btn-sound').innerHTML = this.enabled?'<i class="fas fa-volume-up"></i>':'<i class="fas fa-volume-mute"></i>';
    },
    play(t) {
        if(!this.enabled) return; if(this.ctx.state==='suspended') this.ctx.resume();
        const n=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        if(t==='move'){ o.frequency.setValueAtTime(200,n); o.frequency.exponentialRampToValueAtTime(50,n+0.1); g.gain.setValueAtTime(0.1,n); g.gain.linearRampToValueAtTime(0,n+0.1); o.start(n); o.stop(n+0.1); }
        else if(t==='magic'){ o.type='sine'; o.frequency.setValueAtTime(300,n); o.frequency.linearRampToValueAtTime(800,n+0.5); g.gain.setValueAtTime(0.1,n); g.gain.linearRampToValueAtTime(0,n+0.5); o.start(n); o.stop(n+0.5); }
        else if(t==='win'){ [523,659,783,1046].forEach((f,i)=>{ let o2=this.ctx.createOscillator(),g2=this.ctx.createGain(); o2.connect(g2); g2.connect(this.ctx.destination); o2.frequency.value=f; g2.gain.setValueAtTime(0,n+i*0.1); g2.gain.linearRampToValueAtTime(0.1,n+i*0.1+0.05); g2.gain.exponentialRampToValueAtTime(0.001,n+i*0.1+0.6); o2.start(n+i*0.1); o2.stop(n+i*0.1+0.6); }); }
    }
};

/** UI MANAGER */
const UI = {
    els: {
        board: document.getElementById('game-board'), moves: document.getElementById('val-moves'), time: document.getElementById('val-time'),
        best: document.getElementById('val-best'), hints: document.getElementById('val-hints'), hintBtn: document.getElementById('btn-hint'),
        magicBtn: document.getElementById('btn-magic'), pauseIcon: document.getElementById('icon-pause'), pauseView: document.getElementById('paused-view')
    },
    showToast(m, t='success') {
        const c=document.getElementById('toast-container'), el=document.createElement('div');
        el.className=`toast ${t}`; let i='fa-check-circle'; if(t==='magic')i='fa-wand-magic-sparkles'; if(t==='warning')i='fa-exclamation-circle';
        el.innerHTML=`<i class="fas ${i}"></i><span class="toast-text">${m}</span>`;
        c.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-10px)'; setTimeout(()=>el.remove(),300); },2000);
    },
    showModal(t, d, i, b, cb) {
        document.getElementById('m-title').innerText=t; document.getElementById('m-desc').innerText=d; document.getElementById('m-icon').innerHTML=`<i class="fas ${i}"></i>`;
        const btn=document.getElementById('m-btn'), nBtn=btn.cloneNode(true); btn.parentNode.replaceChild(nBtn, btn);
        nBtn.innerText=b; nBtn.onclick=()=>{ this.closeModal('modal-overlay'); if(cb)cb(); };
        this.openModal('modal-overlay');
    },
    openModal(id){ const m=document.getElementById(id); m.style.display='flex'; m.offsetHeight; m.classList.add('active'); },
    closeModal(id){ const m=document.getElementById(id); m.classList.remove('active'); setTimeout(()=>m.style.display='none',300); }
};

/** GAME ENGINE */
const Game = {
    state: { gridSize:4, tileSize:0, gap:10, tiles:[], emptyPos:{x:3,y:3}, moves:0, timer:0, timerInterval:null, hintsLeft:3, hintCooldown:false, magicAvailable:false, magicMode:false, active:false, paused:false, diff:'medium', maxCorrectCount:0 },
    init() {
        AudioController.init();
        let rT; window.addEventListener('resize', ()=>{ clearTimeout(rT); rT=setTimeout(()=>{ if(this.state.active) this.updateLayout(); },50); });
        document.addEventListener('visibilitychange', ()=>{ if(document.hidden && this.state.active && !this.state.paused) this.togglePause(); });
        document.addEventListener('keydown', (e)=>{
            if(!this.state.active || this.state.paused) return;
            const k=e.key; if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)) {
                e.preventDefault(); let tx=this.state.emptyPos.x, ty=this.state.emptyPos.y;
                if(k==='ArrowUp') ty++; else if(k==='ArrowDown') ty--; else if(k==='ArrowLeft') tx++; else if(k==='ArrowRight') tx--;
                const t=this.state.tiles.find(tile=>tile.x===tx && tile.y===ty); if(t) this.handleMove(t);
            }
        });
    },
    startGame(d) {
        this.state.diff=d; this.state.gridSize=(d==='easy')?3:(d==='medium')?4:5; this.state.magicAvailable=(d!=='easy');
        this.state.moves=0; this.state.timer=0; this.state.hintsLeft=3; this.state.hintCooldown=false; this.state.active=true; this.state.paused=false; this.state.magicMode=false; this.state.maxCorrectCount=0;
        UI.els.moves.innerText='0'; UI.els.time.innerText='00:00'; UI.els.hints.innerText='3';
        UI.els.pauseIcon.className='fas fa-pause'; UI.els.pauseView.classList.remove('active'); UI.els.hintBtn.classList.remove('disabled');
        UI.els.magicBtn.style.display = this.state.magicAvailable?'flex':'none'; UI.els.magicBtn.classList.remove('disabled'); UI.els.magicBtn.style.background=''; UI.els.magicBtn.style.color='';
        UI.els.best.innerText = localStorage.getItem(`mm_best_${d}`) || '-';
        document.getElementById('menu-screen').classList.remove('active'); document.getElementById('game-screen').classList.add('active');
        this.createBoard(); this.startTimer();
    },
    createBoard() {
        UI.els.board.innerHTML=''; this.state.tiles=[];
        this.calculateDimensions();
        let v=1;
        for(let y=0;y<this.state.gridSize;y++){
            for(let x=0;x<this.state.gridSize;x++){
                if(y===this.state.gridSize-1 && x===this.state.gridSize-1){ this.state.emptyPos={x,y}; break; }
                const el=document.createElement('div'); el.className='tile'; el.innerText=v;
                const obj={val:v,x,y,el}; el.onmousedown=()=>this.handleMove(obj); el.ontouchstart=()=>this.handleMove(obj);
                this.state.tiles.push(obj); UI.els.board.appendChild(el); v++;
            }
        }
        this.updateTilePositions(true); this.shuffle();
    },
    calculateDimensions() {
        let w=Math.min(window.innerWidth-40, 500); if(window.innerWidth>=1024) w=Math.min(550, window.innerHeight-150);
        const gt=(this.state.gridSize+1)*this.state.gap; this.state.tileSize=(w-gt)/this.state.gridSize;
        const bPx=this.state.tileSize*this.state.gridSize+gt; UI.els.board.style.width=`${bPx}px`; UI.els.board.style.height=`${bPx}px`;
        this.state.fontSize=Math.max(16, this.state.tileSize*0.45);
    },
    updateLayout() { this.calculateDimensions(); this.updateTilePositions(true); },
    updateTilePositions(inst=false) {
        this.state.tiles.forEach(t=>{
            t.el.style.width=`${this.state.tileSize}px`; t.el.style.height=`${this.state.tileSize}px`; t.el.style.fontSize=`${this.state.fontSize}px`;
            const l=this.state.gap+t.x*(this.state.tileSize+this.state.gap), tp=this.state.gap+t.y*(this.state.tileSize+this.state.gap);
            t.el.style.transform=`translate(${l}px, ${tp}px)`;
            if(inst){ t.el.style.transition='none'; t.el.offsetHeight; t.el.style.transition=''; }
        });
    },
    shuffle() {
        let last=null, tm=this.state.gridSize*80;
        for(let i=0;i<tm;i++){
            const n=this.getNeighbors(this.state.emptyPos), v=n.filter(t=>t!==last), c=v[Math.floor(Math.random()*v.length)]||n[0];
            this.swap(c,true); last=c;
        }
        this.state.moves=0; UI.els.moves.innerText='0';
        let c=0; this.state.tiles.forEach(t=>{ if(t.x===(t.val-1)%this.state.gridSize && t.y===Math.floor((t.val-1)/this.state.gridSize)) c++; });
        this.state.maxCorrectCount=c; this.checkCorrectness(false);
    },
    getNeighbors(p) { return this.state.tiles.filter(t=>(Math.abs(t.x-p.x)+Math.abs(t.y-p.y)===1)); },
    handleMove(t) {
        if(!this.state.active || this.state.paused) return;
        if(this.state.magicMode) { this.executeMagic(t); return; }
        if(Math.abs(t.x-this.state.emptyPos.x)+Math.abs(t.y-this.state.emptyPos.y)===1) {
            const a=t.el.querySelector('.arrow-hint'); if(a) a.remove();
            if(this.state.hintCooldown){ this.state.hintCooldown=false; UI.els.hintBtn.classList.remove('disabled'); }
            this.swap(t); this.state.moves++; UI.els.moves.innerText=this.state.moves; AudioController.play('move'); this.checkCorrectness(true);
        }
    },
    swap(t, inst=false) {
        const tx=t.x, ty=t.y; t.x=this.state.emptyPos.x; t.y=this.state.emptyPos.y; this.state.emptyPos.x=tx; this.state.emptyPos.y=ty;
        const l=this.state.gap+t.x*(this.state.tileSize+this.state.gap), tp=this.state.gap+t.y*(this.state.tileSize+this.state.gap);
        t.el.style.transform=`translate(${l}px, ${tp}px)`; if(inst){ t.el.style.transition='none'; t.el.offsetHeight; t.el.style.transition=''; }
    },
    useMagic() {
        if(!this.state.active || this.state.paused || !this.state.magicAvailable) return;
        this.state.magicMode=!this.state.magicMode;
        if(this.state.magicMode) { UI.els.magicBtn.style.background='#f3e8ff'; UI.els.magicBtn.style.color='#8b5cf6'; UI.showToast('Tap a tile to auto-solve', 'magic'); }
        else { UI.els.magicBtn.style.background=''; UI.els.magicBtn.style.color=''; }
    },
    executeMagic(t) {
        const cx=(t.val-1)%this.state.gridSize, cy=Math.floor((t.val-1)/this.state.gridSize);
        if(t.x===cx && t.y===cy){ UI.showToast('Already correct', 'warning'); return; }
        const obs=this.state.tiles.find(o=>o.x===cx && o.y===cy), tx=t.x, ty=t.y;
        if(obs){ t.x=obs.x; t.y=obs.y; obs.x=tx; obs.y=ty; 
            const ol=this.state.gap+obs.x*(this.state.tileSize+this.state.gap), ot=this.state.gap+obs.y*(this.state.tileSize+this.state.gap);
            obs.el.style.transform=`translate(${ol}px, ${ot}px)`;
        } else { t.x=this.state.emptyPos.x; t.y=this.state.emptyPos.y; this.state.emptyPos.x=tx; this.state.emptyPos.y=ty; }
        const tl=this.state.gap+t.x*(this.state.tileSize+this.state.gap), tt=this.state.gap+t.y*(this.state.tileSize+this.state.gap);
        t.el.style.transform=`translate(${tl}px, ${tt}px)`;
        const others=this.state.tiles.filter(o=>o!==t && o!==obs);
        if(others.length>=2){
            const t1=others[0], t2=others[1], t1x=t1.x, t1y=t1.y;
            t1.x=t2.x; t1.y=t2.y; t2.x=t1x; t2.y=t1y;
            const t1l=this.state.gap+t1.x*(this.state.tileSize+this.state.gap), t1t=this.state.gap+t1.y*(this.state.tileSize+this.state.gap);
            t1.el.style.transform=`translate(${t1l}px, ${t1t}px)`;
            const t2l=this.state.gap+t2.x*(this.state.tileSize+this.state.gap), t2t=this.state.gap+t2.y*(this.state.tileSize+this.state.gap);
            t2.el.style.transform=`translate(${t2l}px, ${t2t}px)`;
        }
        this.state.magicAvailable=false; this.state.magicMode=false; UI.els.magicBtn.classList.add('disabled'); UI.els.magicBtn.style.background=''; AudioController.play('magic'); this.checkCorrectness(true);
    },
    useHint() {
        if(!this.state.active || this.state.paused || this.state.hintsLeft<=0 || this.state.hintCooldown) return;
        let bt=null, md=Infinity; const n=this.getNeighbors(this.state.emptyPos);
        n.forEach(t=>{
            const ox=t.x, oy=t.y; t.x=this.state.emptyPos.x; t.y=this.state.emptyPos.y; let td=0;
            this.state.tiles.forEach(tl=>{ const cx=(tl.val-1)%this.state.gridSize, cy=Math.floor((tl.val-1)/this.state.gridSize); td+=Math.abs(tl.x-cx)+Math.abs(tl.y-cy); });
            t.x=ox; t.y=oy; if(td<md){ md=td; bt=t; }
        });
        if(bt){
            let i='fa-arrow-up'; if(bt.x<this.state.emptyPos.x) i='fa-arrow-right'; else if(bt.x>this.state.emptyPos.x) i='fa-arrow-left'; else if(bt.y<this.state.emptyPos.y) i='fa-arrow-down';
            const o=document.createElement('div'); o.className='arrow-hint'; o.innerHTML=`<i class="fas ${i}"></i>`; bt.el.appendChild(o);
            this.state.hintsLeft--; UI.els.hints.innerText=this.state.hintsLeft; this.state.hintCooldown=true; UI.els.hintBtn.classList.add('disabled');
            setTimeout(()=>{ if(o)o.remove(); },2000);
        }
    },
    checkCorrectness(r) {
        let c=0; this.state.tiles.forEach(t=>{
            const cx=(t.val-1)%this.state.gridSize, cy=Math.floor((t.val-1)/this.state.gridSize);
            if(t.x===cx && t.y===cy){ t.el.classList.add('correct'); c++; } else t.el.classList.remove('correct');
        });
        if(r && c > this.state.maxCorrectCount){
            this.state.maxCorrectCount = c;
            if(this.state.hintsLeft<3 && Math.random()<0.25){ this.state.hintsLeft++; UI.els.hints.innerText=this.state.hintsLeft; UI.showToast('Bonus Hint Earned!'); }
        }
        if(c===this.state.tiles.length) this.gameOver();
    },
    togglePause(){ if(!this.state.active) return; this.state.paused=!this.state.paused; if(this.state.paused){UI.els.pauseView.classList.add('active');UI.els.pauseIcon.className='fas fa-play';}else{UI.els.pauseView.classList.remove('active');UI.els.pauseIcon.className='fas fa-pause';} },
    startTimer(){ clearInterval(this.state.timerInterval); this.state.timerInterval=setInterval(()=>{ if(!this.state.paused && this.state.active){ this.state.timer++; const m=Math.floor(this.state.timer/60).toString().padStart(2,'0'), s=(this.state.timer%60).toString().padStart(2,'0'); UI.els.time.innerText=`${m}:${s}`; } },1000); },
    quitGame(){ this.state.paused=true; UI.showModal('Quit Game?', 'Return to Main Menu?', 'fa-door-open', 'Exit', ()=>{ this.state.active=false; document.getElementById('game-screen').classList.remove('active'); document.getElementById('menu-screen').classList.add('active'); }); },
    gameOver(){ this.state.active=false; clearInterval(this.state.timerInterval); AudioController.play('win'); this.startConfetti(); const cb=localStorage.getItem(`mm_best_${this.state.diff}`); if(!cb || this.state.moves<parseInt(cb)) localStorage.setItem(`mm_best_${this.state.diff}`, this.state.moves); UI.showModal('Victory!', `Solved in ${UI.els.time.innerText} with ${this.state.moves} moves.`, 'fa-trophy', 'Menu', ()=>{ this.stopConfetti(); document.getElementById('game-screen').classList.remove('active'); document.getElementById('menu-screen').classList.add('active'); }); },
    confettiActive:false, particles:[],
    startConfetti(){ const c=document.getElementById('confetti-canvas').getContext('2d'), rs=()=>{c.canvas.width=window.innerWidth;c.canvas.height=window.innerHeight;}; window.addEventListener('resize',rs); rs(); this.confettiActive=true; this.particles=[]; for(let i=0;i<100;i++)this.particles.push({x:window.innerWidth/2,y:window.innerHeight/2,vx:(Math.random()-0.5)*20,vy:(Math.random()-0.5)*20-5,color:`hsl(${Math.random()*360},100%,50%)`,size:Math.random()*10+5,life:100}); this.animateConfetti(c); },
    animateConfetti(c){ if(!this.confettiActive){c.clearRect(0,0,window.innerWidth,window.innerHeight);return;} c.clearRect(0,0,window.innerWidth,window.innerHeight); this.particles.forEach((p,i)=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.5;p.life--;p.size*=0.96;c.fillStyle=p.color;c.fillRect(p.x,p.y,p.size,p.size);if(p.life<=0)this.particles.splice(i,1);}); if(this.particles.length>0)requestAnimationFrame(()=>this.animateConfetti(c)); else this.confettiActive=false; },
    stopConfetti(){ this.confettiActive=false; }
};
window.onload=()=>Game.init();
</script>
</body>
</html>
